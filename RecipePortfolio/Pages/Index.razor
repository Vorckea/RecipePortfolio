@page "/"
@using RecipePortfolio.Data
@using RecipePortfolio.Shared
@inject HttpClient Http

<h1 class="text-center my-4">My Recipe Portfolio</h1>

@if (recipes == null || filteredRecipes == null){
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Loading recipes...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
else
{
    <div class="form-group">
        <input type="text"
               class="form-control"
               @bind="SearchTerm"
               placeholder="Search recipes..."
               @oninput="DebounceSearch" />
    </div>
    
    <div class="row">
        @foreach(var recipe in filteredRecipes){
            <div class="col-md-4 mb-4">
                <RecipeCard Recipe="recipe" />
            </div>
        }
    </div>
}

@code{
    private string searchTerm = "";
    private List<Data.Recipe>? recipes;
    private List<Data.Recipe>? filteredRecipes;
    private string? errorMessage;
    private CancellationTokenSource? debounceCts;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            recipes = await Http.GetFromJsonAsync<List<Data.Recipe>>("data/recipes.json");
            filteredRecipes = recipes;
        }
        catch (Exception e)
        {
            errorMessage = $"Error loading recipes: {e.Message}";
        }
    }

    private string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            DebounceFilerRecipes();
        }
    }

    private void DebounceFilerRecipes()
    {
        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        _ = Task.Delay(300, token).ContinueWith(async task => 
            {
                if (!task.IsCanceled) 
                {
                    await FilterRecipes();
                }
            }, token);
    }

    private async Task FilterRecipes()
    {
        await Task.Delay(150);
        if (recipes == null) return;

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredRecipes = recipes;
        }
        else{
            filteredRecipes = recipes?
            .Where(r =>
                r.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (r.Tags != null && r.Tags.Any(t =>
                    t.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
            )
            .ToList();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void DebounceSearch(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? "";
    }
}